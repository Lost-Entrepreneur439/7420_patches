From f723c2aed71e86e5b84e3d42540f40668346ce72 Mon Sep 17 00:00:00 2001
From: Shilin Victor <chrono.monochrome@gmail.com>
Date: Fri, 15 Oct 2021 11:28:05 +0300
Subject: [PATCH 4/4] HACK: arm: remove version check for memfd_create()

Change-Id: Id1642ed8b4b7a680e72907c00374a35c5b2a9564
---
 libartbase/Android.bp    | 5 +----
 libartbase/base/memfd.cc | 8 ++------
 libartbase/base/memfd.h  | 3 ++-
 3 files changed, 5 insertions(+), 11 deletions(-)

diff --git a/libartbase/Android.bp b/libartbase/Android.bp
index fc53aaa28a..8bd3bd12aa 100644
--- a/libartbase/Android.bp
+++ b/libartbase/Android.bp
@@ -25,10 +25,7 @@ package {
 
 cc_defaults {
     name: "libartbase_defaults",
-    defaults: [
-        "art_defaults",
-        "has_memfd_backport_defaults",
-    ],
+    defaults: ["art_defaults"],
     host_supported: true,
     srcs: [
         "arch/instruction_set.cc",
diff --git a/libartbase/base/memfd.cc b/libartbase/base/memfd.cc
index 84cc66d5f2..134b2dd5a6 100644
--- a/libartbase/base/memfd.cc
+++ b/libartbase/base/memfd.cc
@@ -17,15 +17,11 @@
 #include "memfd.h"
 
 #include <errno.h>
-#if !defined(HAS_MEMFD_BACKPORT)
 #include <stdio.h>
-#endif
 #if !defined(_WIN32)
 #include <fcntl.h>
 #include <sys/syscall.h>
-#if !defined(HAS_MEMFD_BACKPORT)
 #include <sys/utsname.h>
-#endif
 #include <unistd.h>
 #endif
 #if defined(__BIONIC__)
@@ -53,7 +49,7 @@ namespace art {
 #if defined(__NR_memfd_create)
 
 int memfd_create(const char* name, unsigned int flags) {
-#if !defined(HAS_MEMFD_BACKPORT)
+#if 0
   // Check kernel version supports memfd_create(). Some older kernels segfault executing
   // memfd_create() rather than returning ENOSYS (b/116769556).
   static constexpr int kRequiredMajor = 3;
@@ -67,8 +63,8 @@ int memfd_create(const char* name, unsigned int flags) {
     errno = ENOSYS;
     return -1;
   }
-#endif
 
+#endif
   return syscall(__NR_memfd_create, name, flags);
 }
 
diff --git a/libartbase/base/memfd.h b/libartbase/base/memfd.h
index d26101824b..3c27dcb9e3 100644
--- a/libartbase/base/memfd.h
+++ b/libartbase/base/memfd.h
@@ -65,7 +65,8 @@
 
 namespace art {
 
-  // Call memfd(2) if available on platform and return result.
+// Call memfd(2) if available on platform and return result. This call also makes a kernel version
+// check for safety on older kernels (b/116769556)..
 int memfd_create(const char* name, unsigned int flags);
 
 // Call memfd(2) if available on platform and return result. Try to give us an unlinked FD in some
-- 
2.37.1

