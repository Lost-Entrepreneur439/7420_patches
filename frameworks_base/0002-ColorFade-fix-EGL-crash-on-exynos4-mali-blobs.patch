From 0684bdaea1653931febdf2f7e71e8762fee038e8 Mon Sep 17 00:00:00 2001
From: html6405 <peter.schelchshorn@mhs-solutions.at>
Date: Tue, 16 Nov 2021 17:09:08 +0100
Subject: [PATCH 02/18] ColorFade: fix EGL crash on exynos4 mali blobs .

Change-Id: I434668a601c7022f6a5a8c23685d5e9fe4d56713
---
 .../java/com/android/server/display/ColorFade.java    | 11 ++++++++++-
 1 file changed, 10 insertions(+), 1 deletion(-)

diff --git a/services/core/java/com/android/server/display/ColorFade.java b/services/core/java/com/android/server/display/ColorFade.java
index 7cb29215b5bf..c3fd189ea9af 100644
--- a/services/core/java/com/android/server/display/ColorFade.java
+++ b/services/core/java/com/android/server/display/ColorFade.java
@@ -31,6 +31,7 @@ import android.opengl.EGLDisplay;
 import android.opengl.EGLSurface;
 import android.opengl.GLES11Ext;
 import android.opengl.GLES20;
+import android.os.SystemProperties;
 import android.os.IBinder;
 import android.util.Slog;
 import android.view.Display;
@@ -80,6 +81,9 @@ final class ColorFade {
     private static final int EGL_GL_COLORSPACE_DISPLAY_P3_PASSTHROUGH_EXT = 0x3490;
     private static final int EGL_PROTECTED_CONTENT_EXT = 0x32C0;
 
+    private static final boolean DESTROY_SURFACE_AFTER_DETACH =
+            SystemProperties.getBoolean("ro.egl.destroy_after_detach", false);
+
     private final int mDisplayId;
 
     // Set to true when the animation context has been fully prepared.
@@ -373,10 +377,15 @@ final class ColorFade {
                 destroyScreenshotTexture();
                 destroyGLShaders();
                 destroyGLBuffers();
-                destroyEglSurface();
+                if (!DESTROY_SURFACE_AFTER_DETACH) {
+                    destroyEglSurface();
+                }
             } finally {
                 detachEglContext();
             }
+            if (DESTROY_SURFACE_AFTER_DETACH) {
+                destroyEglSurface();
+            }
             // This is being called with no active context so shouldn't be
             // needed but is safer to not change for now.
             GLES20.glFlush();
-- 
2.37.1

