From d59b7315616ba98f33c1f53de867d5884298cf02 Mon Sep 17 00:00:00 2001
From: Dominggoes Isakh <drjisakh@gmail.com>
Date: Thu, 25 Nov 2021 21:32:02 +0100
Subject: [PATCH 2/9] Revert "bpf is always supported"

This reverts commit 0e5d26f4820a84f31b353f4859dbb856e3b55e66.

Change-Id: I117a1c933e635fbf68833a50af33e2625355f3bf
---
 server/NetworkController.cpp | 14 ++++++++------
 server/RouteController.cpp   |  2 ++
 2 files changed, 10 insertions(+), 6 deletions(-)

diff --git a/server/NetworkController.cpp b/server/NetworkController.cpp
index 602639cb..911cac88 100644
--- a/server/NetworkController.cpp
+++ b/server/NetworkController.cpp
@@ -150,12 +150,14 @@ NetworkController::NetworkController() :
     // TODO: perhaps only remove the clsact on the interface which is added by
     // RouteController::addInterfaceToPhysicalNetwork. Currently, the netd only
     // attach the clsact to the interface for the physical network.
-    const auto& ifaces = InterfaceController::getIfaceNames();
-    if (isOk(ifaces)) {
-        for (const std::string& iface : ifaces.value()) {
-            if (int ifIndex = if_nametoindex(iface.c_str())) {
-                // Ignore the error because the interface might not have a clsact.
-                tcQdiscDelDevClsact(ifIndex);
+    if (bpf::isBpfSupported()) {
+        const auto& ifaces = InterfaceController::getIfaceNames();
+        if (isOk(ifaces)) {
+            for (const std::string& iface : ifaces.value()) {
+                if (int ifIndex = if_nametoindex(iface.c_str())) {
+                    // Ignore the error because the interface might not have a clsact.
+                    tcQdiscDelDevClsact(ifIndex);
+                }
             }
         }
     }
diff --git a/server/RouteController.cpp b/server/RouteController.cpp
index ba305e69..c455d358 100644
--- a/server/RouteController.cpp
+++ b/server/RouteController.cpp
@@ -1060,6 +1060,8 @@ int RouteController::modifyRoute(uint16_t action, uint16_t flags, const char* in
 }
 
 static void maybeModifyQdiscClsact(const char* interface, bool add) {
+    if (!bpf::isBpfSupported()) return;
+
     // The clsact attaching of v4- tun interface is triggered by ClatdController::maybeStartBpf
     // because the clat is started before the v4- interface is added to the network and the
     // clat startup needs to add {in, e}gress filters.
-- 
2.37.1

